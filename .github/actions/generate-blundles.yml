name: 'Generate bundles'
description: 'Generate Blender bundles for particular Python version'
inputs:
  python-version:
    description: 'Python version to target'
    required: true
    default: '3.11'
runs:
  using: "composite"
  steps:
    - name: Retrieve wheels
      shell: bash
      run: |
        platforms=(
          macosx_11_0_arm64
          macosx_10_13_x86_64
          manylinux_2_28_x86_64
          win_amd64
        )
        dest="${{ github.workspace }}/BlendLuxCore/wheels"
        for platform in "${platforms[@]}"
        do
          echo "Downloading pyluxcore for ${platform}"
          pip download "pyluxcore==${WHEELS_VERSION}" \
            --no-deps \
            --dest ${dest} \
            --only-binary=:all: \
            --python-version=${{ inputs.python-version }} \
            --platform=$platform
        done

    - name: Package bundles
      shell: bash
      run: |
        echo "${{ github.workspace }}"
        blender --command extension build \
          --split-platform \
          --source-dir "${{ github.workspace }}/BlendLuxCore"

    - name: Separate platforms
      shell: bash
      run: |
        for file_name in ${{ github.workspace }}/BlendLuxCore-*.zip; do
          base_name=$(basename -- "${file_name}")
          target_folder=${base_name%.*}
          echo "Unzipping '${file_name}' into '${target_folder}'"
          unzip -q ${file_name} -d ${target_folder}
        done

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: "BlendLuxCore-linux_x64"
        path: "${{ github.workspace }}/BlendLuxCore-*-linux_x64"

    - name: Upload MacOS arm64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: "BlendLuxCore-macos_arm64"
        path: "${{ github.workspace }}/BlendLuxCore-*-macos_arm64"

    - name: Upload MacOS X64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: "BlendLuxCore-macos_x64"
        path: "${{ github.workspace }}/BlendLuxCore-*-macos_x64"

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: "BlendLuxCore-windows_x64"
        path: "${{ github.workspace }}/BlendLuxCore-*-windows_x64"
